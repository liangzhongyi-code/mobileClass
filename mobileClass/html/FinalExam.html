<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›®å‰ä½ç½®å¤©æ°£æŸ¥è©¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 500px;
            margin: 20px auto;
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fafafa;
        }
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 50px; /* åœ“è§’æŒ‰éˆ• */
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        #status {
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }
        /* å¤©æ°£å¡ç‰‡æ¨£å¼ */
        .weather-card {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(to bottom right, #e0f7fa, #ffffff);
            border-radius: 12px;
            border-left: 5px solid #00bcd4;
            text-align: left;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .location-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #00838f;
            margin-bottom: 10px;
        }
        .weather-info {
            font-size: 1.1rem;
            margin: 8px 0;
            color: #333;
        }
        .hint {
            font-size: 0.8rem;
            color: #999;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <span class="icon">ğŸŒ¤ï¸</span>
    <h1>ç›®å‰ä½ç½®å¤©æ°£</h1>

    <button id="btnGetWeather">ğŸ“ å®šä½ä¸¦æŸ¥è©¢å¤©æ°£</button>

    <div id="status"></div>
    
    <div id="weatherResult" class="weather-card">
        <!-- å¤©æ°£çµæœå°‡é¡¯ç¤ºæ–¼æ­¤ -->
    </div>
</div>

<script>
    const btn = document.getElementById('btnGetWeather');
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('weatherResult');
    
    // ç›´æ¥å®šç¾© API Key
    const API_KEY = 'CWA-BF6FB0B4-8AEB-4B89-B3FA-8B2AAD8F325E';

    // å°ç£å„ç¸£å¸‚ä¸­å¿ƒåº§æ¨™ (ç”¨æ–¼åˆ¤æ–·æœ€è¿‘çš„åŸå¸‚)
    const taiwanCities = [
        { name: "åŸºéš†å¸‚", lat: 25.1276, lon: 121.7392 },
        { name: "è‡ºåŒ—å¸‚", lat: 25.0330, lon: 121.5654 },
        { name: "æ–°åŒ—å¸‚", lat: 25.0170, lon: 121.4625 },
        { name: "æ¡ƒåœ’å¸‚", lat: 24.9936, lon: 121.3010 },
        { name: "æ–°ç«¹å¸‚", lat: 24.8138, lon: 120.9675 },
        { name: "æ–°ç«¹ç¸£", lat: 24.8397, lon: 121.0152 },
        { name: "è‹—æ —ç¸£", lat: 24.5606, lon: 120.8214 },
        { name: "è‡ºä¸­å¸‚", lat: 24.1477, lon: 120.6736 },
        { name: "å½°åŒ–ç¸£", lat: 24.0518, lon: 120.5161 },
        { name: "å—æŠ•ç¸£", lat: 23.9610, lon: 120.6967 },
        { name: "é›²æ—ç¸£", lat: 23.7092, lon: 120.4313 },
        { name: "å˜‰ç¾©å¸‚", lat: 23.4801, lon: 120.4491 },
        { name: "å˜‰ç¾©ç¸£", lat: 23.4518, lon: 120.2555 },
        { name: "è‡ºå—å¸‚", lat: 22.9997, lon: 120.2270 },
        { name: "é«˜é›„å¸‚", lat: 22.6273, lon: 120.3014 },
        { name: "å±æ±ç¸£", lat: 22.6745, lon: 120.4881 },
        { name: "å®œè˜­ç¸£", lat: 24.7517, lon: 121.7483 },
        { name: "èŠ±è“®ç¸£", lat: 23.9872, lon: 121.6016 },
        { name: "è‡ºæ±ç¸£", lat: 22.7583, lon: 121.1444 },
        { name: "æ¾æ¹–ç¸£", lat: 23.5712, lon: 119.5797 },
        { name: "é‡‘é–€ç¸£", lat: 24.4404, lon: 118.3226 },
        { name: "é€£æ±Ÿç¸£", lat: 26.1580, lon: 119.9510 }
    ];

    btn.addEventListener('click', () => {
        // 1. åˆå§‹åŒ– UI
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'ğŸ›°ï¸ æ­£åœ¨å®šä½ä¸­...';
        resultDiv.style.display = 'none';
        btn.disabled = true;
        btn.textContent = 'è™•ç†ä¸­...';

        // 2. å–å¾—åœ°ç†ä½ç½®
        if (!navigator.geolocation) {
            statusDiv.textContent = 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½ã€‚';
            resetBtn();
            return;
        }

        navigator.geolocation.getCurrentPosition(success, error);

        function success(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            statusDiv.textContent = `å®šä½æˆåŠŸï¼\næ­£åœ¨æŸ¥è©¢å¤©æ°£...`;

            // 3. å‘¼å«æ°£è±¡ç½² API
            fetchWeather(API_KEY, lat, lng);
        }

        function error(err) {
            statusDiv.textContent = `å®šä½å¤±æ•—: ${err.message}\n(è«‹ç¢ºèªå·²é–‹å•Ÿæ‰‹æ©Ÿ GPS ä¸¦å…è¨±å®šä½æ¬Šé™)`;
            resetBtn();
        }
    });

    function fetchWeather(key, userLat, userLng) {
        const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${key}&format=JSON`;

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success === 'true') {
                    const nearestCity = getNearestCity(userLat, userLng);
                    const locationData = data.records.location.find(loc => loc.locationName === nearestCity.name);
                    
                    if (locationData) {
                        displayWeather(locationData, nearestCity.name);
                    } else {
                        statusDiv.textContent = `æ‰¾ä¸åˆ° ${nearestCity.name} çš„è³‡æ–™ã€‚`;
                    }
                } else {
                    statusDiv.textContent = 'API é©—è­‰å¤±æ•—ã€‚';
                }
            })
            .catch(e => {
                statusDiv.textContent = `é€£ç·šéŒ¯èª¤: ${e.message}`;
            })
            .finally(() => {
                resetBtn();
            });
    }

    // è¨ˆç®—è·é›¢ä¸¦æ‰¾å‡ºæœ€è¿‘çš„ç¸£å¸‚
    function getNearestCity(lat, lon) {
        let minDistance = Infinity;
        let nearest = null;

        taiwanCities.forEach(city => {
            const d = getDistanceFromLatLonInKm(lat, lon, city.lat, city.lon);
            if (d < minDistance) {
                minDistance = d;
                nearest = city;
            }
        });
        return nearest;
    }

    // é¡¯ç¤ºå–®ä¸€ç¸£å¸‚çš„å¤©æ°£
    function displayWeather(location, cityName) {
        const weatherElement = location.weatherElement;
        
        // è§£æéœ€è¦çš„æ°£è±¡å› å­
        // Wx: å¤©æ°£ç¾è±¡, PoP: é™é›¨æ©Ÿç‡, MinT: æœ€ä½æº«, CI: èˆ’é©åº¦, MaxT: æœ€é«˜æº«
        const getVal = (code) => weatherElement.find(el => el.elementName === code).time[0].parameter.parameterName;
        
        const wx = getVal('Wx');
        const pop = getVal('PoP');
        const minT = getVal('MinT');
        const maxT = getVal('MaxT');
        const ci = getVal('CI');
        const timeInfo = weatherElement[0].time[0]; // æ™‚é–“å€æ®µ

        // é¡¯ç¤ºå…§å®¹
        resultDiv.innerHTML = `
            <div class="location-title">ğŸ“ ${cityName}</div>
            <div class="weather-info"><b>${wx}</b></div>
            <div class="weather-info">ğŸŒ¡ï¸ æ°£æº«ï¼š${minT}Â°C ~ ${maxT}Â°C</div>
            <div class="weather-info">â˜” é™é›¨æ©Ÿç‡ï¼š${pop}%</div>
            <div class="weather-info">ğŸ˜Š èˆ’é©åº¦ï¼š${ci}</div>
            <div class="hint">é å ±æ™‚é–“ï¼š${timeInfo.startTime.split(' ')[1].slice(0,5)} ~ ${timeInfo.endTime.split(' ')[1].slice(0,5)}</div>
        `;
        
        resultDiv.style.display = 'block';
        statusDiv.style.display = 'none'; // éš±è—ç‹€æ…‹æ–‡å­—ï¼Œè®“ç•«é¢ä¹¾æ·¨
    }

    function resetBtn() {
        btn.disabled = false;
        btn.textContent = 'ğŸ“ å®šä½ä¸¦æŸ¥è©¢å¤©æ°£';
    }

    // è¨ˆç®—å…©é»ç¶“ç·¯åº¦è·é›¢ (Haversine formula)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; // åœ°çƒåŠå¾‘ (km)
        var dLat = deg2rad(lat2 - lat1);
        var dLon = deg2rad(lon2 - lon1);
        var a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c; // Distance in km
        return d;
    }

    function deg2rad(deg) {
        return deg * (Math.PI / 180);
    }
</script>

</body>
</html>