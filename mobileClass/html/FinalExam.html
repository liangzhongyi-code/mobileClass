<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å¤©æ°£æŸ¥è©¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fafafa;
        }

        select {
            cursor: pointer;
        }

        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 50px;
            /* åœ“è§’æŒ‰éˆ• */
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        #status {
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        /* å¤©æ°£å¡ç‰‡æ¨£å¼ */
        .weather-card {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(to bottom right, #e0f7fa, #ffffff);
            border-radius: 12px;
            border-left: 5px solid #00bcd4;
            text-align: left;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .location-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #00838f;
            margin-bottom: 10px;
        }

        .weather-info {
            font-size: 1.1rem;
            margin: 8px 0;
            color: #333;
        }

        .hint {
            font-size: 0.8rem;
            color: #999;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <span class="icon">ğŸŒ¤ï¸</span>
        <h1>å°ç£å¤©æ°£æŸ¥è©¢</h1>

        <!-- æ–°å¢ï¼šæ‰‹å‹•æŸ¥è©¢å€åŸŸ -->
        <div class="form-group">
            <label for="selectDate">é¸æ“‡æ—¥æœŸ</label>
            <input type="date" id="selectDate" />
        </div>

        <div class="form-group">
            <label for="selectCity">é¸æ“‡ç¸£å¸‚</label>
            <select id="selectCity">
                <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
                <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
                <option value="è‡ºåŒ—å¸‚">è‡ºåŒ—å¸‚</option>
                <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
                <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
                <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option>
                <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
                <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
                <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                <option value="è‡ºå—å¸‚">è‡ºå—å¸‚</option>
                <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                <option value="å±æ±ç¸£">å±æ±ç¸£</option>
                <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
                <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                <option value="è‡ºæ±ç¸£">è‡ºæ±ç¸£</option>
                <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
                <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
            </select>
        </div>

        <button id="btnQueryBySelection">ğŸ” æŸ¥è©¢å¤©æ°£</button>

        <div style="margin: 25px 0; text-align: center; color: #ccc; font-size: 14px;">
            æˆ–
        </div>

        <button id="btnGetWeather">ğŸ“ å®šä½ä¸¦æŸ¥è©¢å¤©æ°£</button>

        <div id="status"></div>

        <div id="weatherResult" class="weather-card">
            <!-- å¤©æ°£çµæœå°‡é¡¯ç¤ºæ–¼æ­¤ -->
        </div>
    </div>

    <script>
        const btn = document.getElementById('btnGetWeather');
        const btnQuery = document.getElementById('btnQueryBySelection');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('weatherResult');
        const dateInput = document.getElementById('selectDate');
        const citySelect = document.getElementById('selectCity');

        // ç›´æ¥å®šç¾© API Key
        const API_KEY = 'CWA-BF6FB0B4-8AEB-4B89-B3FA-8B2AAD8F325E';

        // è¨­å®šæ—¥æœŸé¸æ“‡å™¨çš„é è¨­å€¼ç‚ºä»Šå¤©
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;

        // è¨­å®šæ—¥æœŸé¸æ“‡å™¨çš„ç¯„åœ (ä»Šå¤©åˆ°ä¸€é€±å¾Œ)
        dateInput.min = today;
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 7);
        dateInput.max = maxDate.toISOString().split('T')[0];

        // å°ç£å„ç¸£å¸‚ä¸­å¿ƒåº§æ¨™èˆ‡ API ä»£ç¢¼
        const taiwanCities = [
            { name: "åŸºéš†å¸‚", apiCode: "F-D0047-051", lat: 25.1276, lon: 121.7392 },
            { name: "è‡ºåŒ—å¸‚", apiCode: "F-D0047-063", lat: 25.0330, lon: 121.5654 },
            { name: "æ–°åŒ—å¸‚", apiCode: "F-D0047-071", lat: 25.0170, lon: 121.4625 },
            { name: "æ¡ƒåœ’å¸‚", apiCode: "F-D0047-007", lat: 24.9936, lon: 121.3010 },
            { name: "æ–°ç«¹å¸‚", apiCode: "F-D0047-055", lat: 24.8138, lon: 120.9675 },
            { name: "æ–°ç«¹ç¸£", apiCode: "F-D0047-011", lat: 24.8397, lon: 121.0152 },
            { name: "è‹—æ —ç¸£", apiCode: "F-D0047-015", lat: 24.5606, lon: 120.8214 },
            { name: "è‡ºä¸­å¸‚", apiCode: "F-D0047-075", lat: 24.1477, lon: 120.6736 },
            { name: "å½°åŒ–ç¸£", apiCode: "F-D0047-019", lat: 24.0518, lon: 120.5161 },
            { name: "å—æŠ•ç¸£", apiCode: "F-D0047-023", lat: 23.9610, lon: 120.6967 },
            { name: "é›²æ—ç¸£", apiCode: "F-D0047-027", lat: 23.7092, lon: 120.4313 },
            { name: "å˜‰ç¾©å¸‚", apiCode: "F-D0047-059", lat: 23.4801, lon: 120.4491 },
            { name: "å˜‰ç¾©ç¸£", apiCode: "F-D0047-031", lat: 23.4518, lon: 120.2555 },
            { name: "è‡ºå—å¸‚", apiCode: "F-D0047-079", lat: 22.9997, lon: 120.2270 },
            { name: "é«˜é›„å¸‚", apiCode: "F-D0047-067", lat: 22.6273, lon: 120.3014 },
            { name: "å±æ±ç¸£", apiCode: "F-D0047-035", lat: 22.6745, lon: 120.4881 },
            { name: "å®œè˜­ç¸£", apiCode: "F-D0047-003", lat: 24.7517, lon: 121.7483 },
            { name: "èŠ±è“®ç¸£", apiCode: "F-D0047-043", lat: 23.9872, lon: 121.6016 },
            { name: "è‡ºæ±ç¸£", apiCode: "F-D0047-047", lat: 22.7583, lon: 121.1444 },
            { name: "æ¾æ¹–ç¸£", apiCode: "F-D0047-039", lat: 23.5712, lon: 119.5797 },
            { name: "é‡‘é–€ç¸£", apiCode: "F-D0047-083", lat: 24.4404, lon: 118.3226 },
            { name: "é€£æ±Ÿç¸£", apiCode: "F-D0047-087", lat: 26.1580, lon: 119.9510 }
        ];

        // æ–°å¢ï¼šæ‰‹å‹•æŸ¥è©¢æŒ‰éˆ•äº‹ä»¶
        btnQuery.addEventListener('click', () => {
            const selectedCity = citySelect.value;
            const selectedDate = dateInput.value;

            if (!selectedCity) {
                alert('è«‹é¸æ“‡ç¸£å¸‚ï¼');
                return;
            }

            if (!selectedDate) {
                alert('è«‹é¸æ“‡æ—¥æœŸï¼');
                return;
            }

            // åˆå§‹åŒ– UI
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'ğŸ” æ­£åœ¨æŸ¥è©¢å¤©æ°£...';
            resultDiv.style.display = 'none';
            btnQuery.disabled = true;
            btnQuery.textContent = 'è™•ç†ä¸­...';

            // æŸ¥è©¢æŒ‡å®šç¸£å¸‚çš„å¤©æ°£
            fetchWeatherByCity(selectedCity, selectedDate);
        });

        // æ ¹æ“šç¸£å¸‚æŸ¥è©¢å¤©æ°£çš„å‡½æ•¸
        function fetchWeatherByCity(cityName, selectedDate) {
            // æ‰¾å‡ºè©²ç¸£å¸‚å°æ‡‰çš„ API ä»£ç¢¼
            const cityInfo = taiwanCities.find(city => city.name === cityName);
            if (!cityInfo) {
                statusDiv.textContent = `æ‰¾ä¸åˆ° ${cityName} çš„è³‡æ–™ã€‚`;
                resetBtnQuery();
                return;
            }

            const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/${cityInfo.apiCode}?Authorization=${API_KEY}&format=JSON`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data);

                    if (data.success === 'true' && data.records && data.records.Locations) {
                        // æ–° API æ ¼å¼ï¼šdata.records.Locations[0].Location[0]
                        const locations = data.records.Locations[0];
                        if (locations && locations.Location && locations.Location.length > 0) {
                            displayWeatherByDate(locations.Location[0], cityName, selectedDate);
                        } else {
                            statusDiv.textContent = `æ‰¾ä¸åˆ° ${cityName} çš„è³‡æ–™ã€‚`;
                        }
                    } else {
                        statusDiv.textContent = 'API é©—è­‰å¤±æ•—æˆ–è³‡æ–™æ ¼å¼éŒ¯èª¤ã€‚';
                    }
                })
                .catch(e => {
                    statusDiv.textContent = `é€£ç·šéŒ¯èª¤: ${e.message}`;
                })
                .finally(() => {
                    resetBtnQuery();
                });
        }

        // æ ¹æ“šé¸å®šæ—¥æœŸé¡¯ç¤ºå¤©æ°£
        function displayWeatherByDate(location, cityName, selectedDate) {
            const weatherElement = location.WeatherElement;

            // æ‰¾å‡ºç¬¦åˆçš„æ™‚æ®µ
            let targetData = null;

            // å–å¾—ç¬¬ä¸€å€‹ element çš„æ™‚é–“è³‡è¨Šä¾†å°‹æ‰¾ç¬¦åˆçš„æ™‚æ®µ
            if (weatherElement && weatherElement.length > 0 && weatherElement[0].Time) {
                const timeSlots = weatherElement[0].Time;

                for (let i = 0; i < timeSlots.length; i++) {
                    const slot = timeSlots[i];
                    const startTime = new Date(slot.StartTime);
                    const selected = new Date(selectedDate);

                    // åªæ¯”è¼ƒæ—¥æœŸéƒ¨åˆ†
                    if (selected.toDateString() === startTime.toDateString()) {
                        targetData = { slot: slot, index: i };
                        break;
                    }
                }

                if (!targetData) {
                    // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆçš„æ™‚æ®µï¼Œä½¿ç”¨ç¬¬ä¸€å€‹æ™‚æ®µ
                    targetData = { slot: timeSlots[0], index: 0 };
                }
            }

            // è§£æéœ€è¦çš„æ°£è±¡å› å­
            const getVal = (elementName) => {
                const element = weatherElement.find(el => el.ElementName === elementName);
                if (element && element.Time && element.Time[targetData.index]) {
                    const timeData = element.Time[targetData.index];
                    if (timeData.ElementValue && timeData.ElementValue[0]) {
                        // å–å¾—ç¬¬ä¸€å€‹å¯ç”¨çš„å€¼
                        const firstValue = timeData.ElementValue[0];
                        return firstValue[Object.keys(firstValue)[0]] || 'N/A';
                    }
                }
                return 'N/A';
            };

            const wx = getVal('å¤©æ°£ç¾è±¡');  // å¤©æ°£ç¾è±¡
            const pop = getVal('12å°æ™‚é™é›¨æ©Ÿç‡');  // é™é›¨æ©Ÿç‡
            const minT = getVal('æœ€ä½æº«åº¦');  // æœ€ä½æº«åº¦
            const maxT = getVal('æœ€é«˜æº«åº¦');  // æœ€é«˜æº«åº¦
            const ci = getVal('æœ€å¤§èˆ’é©åº¦æŒ‡æ•¸');  // èˆ’é©åº¦

            // é¡¯ç¤ºå…§å®¹
            resultDiv.innerHTML = `
            <div class="location-title">ğŸ“ ${cityName}</div>
            <div class="weather-info"><b>${wx}</b></div>
            <div class="weather-info">ğŸŒ¡ï¸ æ°£æº«ï¼š${minT}Â°C ~ ${maxT}Â°C</div>
            <div class="weather-info">â˜” é™é›¨æ©Ÿç‡ï¼š${pop}%</div>
            <div class="weather-info">ğŸ˜Š èˆ’é©åº¦ï¼š${ci}</div>
            <div class="hint">é å ±æ™‚é–“ï¼š${targetData.slot.StartTime.split('T')[0]} ${targetData.slot.StartTime.split('T')[1].slice(0, 5)} ~ ${targetData.slot.EndTime.split('T')[1].slice(0, 5)}</div>
        `;

            resultDiv.style.display = 'block';
            statusDiv.style.display = 'none'; // éš±è—ç‹€æ…‹æ–‡å­—ï¼Œè®“ç•«é¢ä¹¾æ·¨
        }

        function resetBtnQuery() {
            btnQuery.disabled = false;
            btnQuery.textContent = 'ğŸ” æŸ¥è©¢å¤©æ°£';
        }

        btn.addEventListener('click', () => {
            // 1. åˆå§‹åŒ– UI
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'ğŸ›°ï¸ æ­£åœ¨å®šä½ä¸­...';
            resultDiv.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';

            // 2. å–å¾—åœ°ç†ä½ç½®
            if (!navigator.geolocation) {
                statusDiv.textContent = 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½ã€‚';
                resetBtn();
                return;
            }

            navigator.geolocation.getCurrentPosition(success, error);

            function success(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                statusDiv.textContent = `å®šä½æˆåŠŸï¼\næ­£åœ¨æŸ¥è©¢å¤©æ°£...`;

                // 3. å‘¼å«æ°£è±¡ç½² API
                fetchWeather(lat, lng);
            }

            function error(err) {
                statusDiv.textContent = `å®šä½å¤±æ•—: ${err.message}\n(è«‹ç¢ºèªå·²é–‹å•Ÿæ‰‹æ©Ÿ GPS ä¸¦å…è¨±å®šä½æ¬Šé™)`;
                resetBtn();
            }
        });

        function fetchWeather(userLat, userLng) {
            const nearestCity = getNearestCity(userLat, userLng);
            const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/${nearestCity.apiCode}?Authorization=${API_KEY}&format=JSON`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.success === 'true' && data.records && data.records.Locations) {
                        const locations = data.records.Locations[0];
                        if (locations && locations.Location && locations.Location.length > 0) {
                            displayWeather(locations.Location[0], nearestCity.name);
                        } else {
                            statusDiv.textContent = `æ‰¾ä¸åˆ° ${nearestCity.name} çš„è³‡æ–™ã€‚`;
                        }
                    } else {
                        statusDiv.textContent = 'API é©—è­‰å¤±æ•—ã€‚';
                    }
                })
                .catch(e => {
                    statusDiv.textContent = `é€£ç·šéŒ¯èª¤: ${e.message}`;
                })
                .finally(() => {
                    resetBtn();
                });
        }

        // è¨ˆç®—è·é›¢ä¸¦æ‰¾å‡ºæœ€è¿‘çš„ç¸£å¸‚
        function getNearestCity(lat, lon) {
            let minDistance = Infinity;
            let nearest = null;

            taiwanCities.forEach(city => {
                const d = getDistanceFromLatLonInKm(lat, lon, city.lat, city.lon);
                if (d < minDistance) {
                    minDistance = d;
                    nearest = city;
                }
            });
            return nearest;
        }

        // é¡¯ç¤ºå–®ä¸€ç¸£å¸‚çš„å¤©æ°£ï¼ˆGPS å®šä½ä½¿ç”¨ï¼Œé¡¯ç¤ºç•¶å‰æ™‚æ®µï¼‰
        function displayWeather(location, cityName) {
            const weatherElement = location.WeatherElement;

            // è§£æéœ€è¦çš„æ°£è±¡å› å­ï¼ˆå–ç¬¬ä¸€å€‹æ™‚æ®µï¼Œå³æœ€è¿‘çš„é å ±ï¼‰
            const getVal = (elementName) => {
                const element = weatherElement.find(el => el.ElementName === elementName);
                if (element && element.Time && element.Time[0]) {
                    const timeData = element.Time[0];
                    if (timeData.ElementValue && timeData.ElementValue[0]) {
                        const firstValue = timeData.ElementValue[0];
                        return firstValue[Object.keys(firstValue)[0]] || 'N/A';
                    }
                }
                return 'N/A';
            };

            const wx = getVal('å¤©æ°£ç¾è±¡');  // å¤©æ°£ç¾è±¡
            const pop = getVal('12å°æ™‚é™é›¨æ©Ÿç‡');  // é™é›¨æ©Ÿç‡
            const minT = getVal('æœ€ä½æº«åº¦');  // æœ€ä½æº«åº¦
            const maxT = getVal('æœ€é«˜æº«åº¦');  // æœ€é«˜æº«åº¦
            const ci = getVal('æœ€å¤§èˆ’é©åº¦æŒ‡æ•¸');  // èˆ’é©åº¦
            const timeInfo = weatherElement[0].Time[0]; // æ™‚é–“å€æ®µ

            // é¡¯ç¤ºå…§å®¹
            resultDiv.innerHTML = `
            <div class="location-title">ğŸ“ ${cityName}</div>
            <div class="weather-info"><b>${wx}</b></div>
            <div class="weather-info">ğŸŒ¡ï¸ æ°£æº«ï¼š${minT}Â°C ~ ${maxT}Â°C</div>
            <div class="weather-info">â˜” é™é›¨æ©Ÿç‡ï¼š${pop}%</div>
            <div class="weather-info">ğŸ˜Š èˆ’é©åº¦ï¼š${ci}</div>
            <div class="hint">é å ±æ™‚é–“ï¼š${timeInfo.StartTime.split('T')[0]} ${timeInfo.StartTime.split('T')[1].slice(0, 5)} ~ ${timeInfo.EndTime.split('T')[1].slice(0, 5)}</div>
        `;

            resultDiv.style.display = 'block';
            statusDiv.style.display = 'none'; // éš±è—ç‹€æ…‹æ–‡å­—ï¼Œè®“ç•«é¢ä¹¾æ·¨
        }

        function resetBtn() {
            btn.disabled = false;
            btn.textContent = 'ğŸ“ å®šä½ä¸¦æŸ¥è©¢å¤©æ°£';
        }

        // è¨ˆç®—å…©é»ç¶“ç·¯åº¦è·é›¢ (Haversine formula)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // åœ°çƒåŠå¾‘ (km)
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }
    </script>

</body>

</html>